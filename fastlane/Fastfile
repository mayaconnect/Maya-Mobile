default_platform(:ios)

platform :ios do

  desc "Setup certificates and provisioning profiles with Match"
  lane :setup_certificates do
    match(
      type: "appstore",
      readonly: true,
      git_url: ENV["MATCH_GIT_URL"],
      git_basic_authorization: ENV["MATCH_GIT_BASIC_AUTHORIZATION"]
    )
  end

  desc "Increment build number"
  lane :increment_build do
    increment_build_number(
      xcodeproj: "ios/Maya.xcodeproj"
    )
  end

  desc "Build iOS app for App Store"
  lane :build do
    # Get certificates
    setup_certificates

    # Configure development team in Xcode project
    if ENV["APPLE_TEAM_ID"]
      update_project_team(
        path: "ios/Maya.xcodeproj",
        teamid: ENV["APPLE_TEAM_ID"]
      )
    end

    # Increment build number
    increment_build

    # Build the app (no clean needed, expo prebuild already does --clean)
    # Note: paths are relative to project root where fastlane is executed
    # Use the scheme name created by Expo (usually the app name from app.json or "Maya" or "App")
    # IMPORTANT: Expo generates the workspace as "Maya.xcworkspace" but the scheme
    # might be different. We use ENV variable to allow workflow to override it.
    scheme_name = ENV["IOS_SCHEME_NAME"] || "Maya"

    # Simplified build configuration
    # Force destination to avoid "multiple matching destinations" issues
    puts "ðŸ”¨ Building with configuration:"
    puts "  Workspace: ios/Maya.xcworkspace"
    puts "  Scheme: #{scheme_name}"
    puts "  Export method: app-store"
    puts ""

    build_app(
      workspace: "ios/Maya.xcworkspace",
      scheme: scheme_name,
      export_method: "app-store",
      destination: "generic/platform=iOS",
      export_options: {
        provisioningProfiles: {
          "com.mayaconnect.app" => "match AppStore com.mayaconnect.app"
        }
      },
      clean: true
    )
  end

  desc "Upload to TestFlight"
  lane :beta do
    # Setup API Key for authentication
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_filepath: "./fastlane/keys/AuthKey_#{ENV['APP_STORE_CONNECT_KEY_ID']}.p8",
      in_house: false
    )

    # Build the app
    build

    # Configuration des groupes de testeurs TestFlight
    # Les groupes doivent Ãªtre crÃ©Ã©s dans App Store Connect avant d'Ãªtre utilisÃ©s ici
    # Exemple de noms de groupes : "Internal Testers", "Beta Testers", "QA Team", etc.
    testflight_groups = ENV["TESTFLIGHT_GROUPS"] ? ENV["TESTFLIGHT_GROUPS"].split(",").map(&:strip) : []
    distribute_external = ENV["TESTFLIGHT_DISTRIBUTE_EXTERNAL"] == "true"
    notify_external_testers = ENV["TESTFLIGHT_NOTIFY_EXTERNAL"] == "true"

    # Upload to TestFlight
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
      skip_submission: true,
      # Distribution aux testeurs
      distribute_external: distribute_external,
      notify_external_testers: notify_external_testers,
      # Groupes de testeurs (optionnel - si vide, distribue Ã  tous les testeurs internes)
      groups: testflight_groups.empty? ? nil : testflight_groups,
      # Informations pour les testeurs (optionnel)
      beta_app_description: ENV["TESTFLIGHT_BETA_DESCRIPTION"] || "Nouvelle version de Maya disponible pour test",
      # Review info (requis si distribute_external: true)
      beta_app_review_info: distribute_external ? {
        contact_email: ENV["TESTFLIGHT_CONTACT_EMAIL"] || ENV["FASTLANE_APPLE_ID"],
        contact_first_name: ENV["TESTFLIGHT_CONTACT_FIRST_NAME"] || "Maya",
        contact_last_name: ENV["TESTFLIGHT_CONTACT_LAST_NAME"] || "Team",
        contact_phone: ENV["TESTFLIGHT_CONTACT_PHONE"] || "",
        demo_account_name: ENV["TESTFLIGHT_DEMO_ACCOUNT"] || "",
        demo_account_password: ENV["TESTFLIGHT_DEMO_PASSWORD"] || "",
        notes: ENV["TESTFLIGHT_REVIEW_NOTES"] || "Application de test pour Maya"
      } : nil
    )

    puts "âœ… Successfully uploaded to TestFlight!"
    if testflight_groups.any?
      puts "ðŸ“± DistribuÃ© aux groupes : #{testflight_groups.join(', ')}"
    else
      puts "ðŸ“± DistribuÃ© Ã  tous les testeurs internes"
    end
    puts "ðŸ”— Check status at: https://appstoreconnect.apple.com/"
  end

  desc "Deploy to App Store"
  lane :release do
    # Setup API Key
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_filepath: "./fastlane/keys/AuthKey_#{ENV['APP_STORE_CONNECT_KEY_ID']}.p8",
      in_house: false
    )

    # Build the app
    build

    # Upload to App Store
    upload_to_app_store(
      api_key: api_key,
      skip_metadata: false,
      skip_screenshots: false,
      submit_for_review: false,
      automatic_release: false
    )

    puts "âœ… Successfully uploaded to App Store!"
    puts "ðŸ”— Complete submission at: https://appstoreconnect.apple.com/"
  end

end
name: Build Check with Fastlane

on:
  pull_request:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:

jobs:
  # ==========================================
  # BUILD ANDROID - V√©rification du build
  # ==========================================
  build-android:
    name: ü§ñ Build Android APK
    runs-on: ubuntu-latest
    env:
      EXPO_PUBLIC_API_BASE_URL: ${{ secrets.EXPO_PUBLIC_API_BASE_URL }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üíæ Backup Fastlane configuration
        run: |
          mkdir -p /tmp/fastlane-backup
          cp -r android/fastlane /tmp/fastlane-backup/ || echo "No fastlane folder to backup"

      - name: üìù Create .env file for API URL
        run: |
          if [ -z "${{ secrets.EXPO_PUBLIC_API_BASE_URL }}" ]; then
            echo "‚ö†Ô∏è WARNING: EXPO_PUBLIC_API_BASE_URL secret is not set!"
            echo "The app will use the default API URL from the code."
          else
            echo "EXPO_PUBLIC_API_BASE_URL=${{ secrets.EXPO_PUBLIC_API_BASE_URL }}" > .env
            echo "‚úÖ .env file created with API URL"
            # Verify the file was created (without showing the actual URL)
            if [ -f ".env" ]; then
              echo "‚úÖ .env file exists"
              echo "API URL configured: EXPO_PUBLIC_API_BASE_URL=***"
            else
              echo "‚ùå ERROR: .env file was not created"
              exit 1
            fi
          fi

      - name: üî® Generate Android native folder
        run: |
          # Export the variable so it's available during prebuild
          export EXPO_PUBLIC_API_BASE_URL="${{ secrets.EXPO_PUBLIC_API_BASE_URL }}"
          npx expo prebuild --platform android --clean

      - name: üìã Restore Fastlane configuration
        run: |
          cp -r /tmp/fastlane-backup/fastlane android/
          echo "Fastlane configuration restored"
          ls -la android/fastlane/

      - name: üîß Set gradlew permissions
        working-directory: android
        run: |
          chmod +x gradlew
          echo "‚úÖ Gradlew permissions set"

      - name: üîß Generate React Native Codegen artifacts
        working-directory: android
        run: |
          echo "Generating codegen artifacts for all modules..."
          # Generate codegen artifacts for all native modules, not just the app
          ./gradlew generateCodegenArtifactsFromSchema --stacktrace || {
            echo "‚ö†Ô∏è Codegen generation had issues, but continuing..."
            exit 0
          }
          echo "‚úÖ Codegen artifacts generated"

      - name: üíé Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: üîê Create dummy keystore for build check
        run: |
          # Cr√©er un keystore temporaire juste pour v√©rifier que le build fonctionne
          keytool -genkey -v -keystore android/app/dummy.keystore \
            -alias dummy -keyalg RSA -keysize 2048 -validity 1 \
            -storepass dummy123 -keypass dummy123 \
            -dname "CN=DummyBuild, OU=Dev, O=Maya, L=City, S=State, C=US"

      - name: ‚öôÔ∏è Create gradle.properties for build check
        run: |
          cat << EOF > android/gradle.properties
          MAYA_UPLOAD_STORE_FILE=dummy.keystore
          MAYA_UPLOAD_KEY_ALIAS=dummy
          MAYA_UPLOAD_STORE_PASSWORD=dummy123
          MAYA_UPLOAD_KEY_PASSWORD=dummy123

          # Gradle settings
          org.gradle.jvmargs=-Xmx2048m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          android.useAndroidX=true
          android.enableJetifier=true

          # React Native / Hermes settings
          hermesEnabled=true
          newArchEnabled=true
          EOF

      - name: üîç Debug - Check paths and fastlane folder
        run: |
          echo "Current directory:"
          pwd
          echo -e "\nRoot directory contents:"
          ls -la
          echo -e "\nAndroid fastlane folder:"
          ls -la android/fastlane/ || echo "android/fastlane not found"

      - name: üèóÔ∏è Build Android APK with Fastlane
        working-directory: android
        run: bundle exec fastlane build_apk

      - name: üì§ Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-build-check
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 7

      - name: ‚úÖ Build successful
        run: echo "‚úÖ Android build completed successfully!"

  # ==========================================
  # BUILD iOS - V√©rification du build
  # ==========================================
  build-ios:
    name: üçé Build iOS (Check Only)
    runs-on: macos-15  # macOS 15 with Xcode 16.x (required by React Native 0.81)
    env:
      EXPO_PUBLIC_API_BASE_URL: ${{ secrets.EXPO_PUBLIC_API_BASE_URL }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install dependencies (excluding dev dependencies for Release)
        run: npm ci --omit=dev

      - name: üîß Select Xcode 16.1
        run: |
          sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer
          xcodebuild -version

      - name: üìù Create .env file for API URL
        run: |
          if [ -z "${{ secrets.EXPO_PUBLIC_API_BASE_URL }}" ]; then
            echo "‚ö†Ô∏è WARNING: EXPO_PUBLIC_API_BASE_URL secret is not set!"
            echo "The app will use the default API URL from the code."
          else
            echo "EXPO_PUBLIC_API_BASE_URL=${{ secrets.EXPO_PUBLIC_API_BASE_URL }}" > .env
            echo "‚úÖ .env file created with API URL"
            # Verify the file was created (without showing the actual URL)
            if [ -f ".env" ]; then
              echo "‚úÖ .env file exists"
              echo "API URL configured: EXPO_PUBLIC_API_BASE_URL=***"
            else
              echo "‚ùå ERROR: .env file was not created"
              exit 1
            fi
          fi

      - name: üî® Generate iOS native folder
        run: |
          # Export the variable so it's available during prebuild
          export EXPO_PUBLIC_API_BASE_URL="${{ secrets.EXPO_PUBLIC_API_BASE_URL }}"
          npx expo prebuild --platform ios --clean

      - name: üîß Fix iOS nullability issues
        run: |
          chmod +x scripts/fix-ios-nullability.sh
          bash scripts/fix-ios-nullability.sh

      - name: üîß Set iOS deployment target in Xcode project
        run: |
          # Find the Xcode project file dynamically
          PROJECT_FILE=$(find ios -name "project.pbxproj" -type f | head -n 1)
          if [ -n "$PROJECT_FILE" ]; then
            echo "üì± Found Xcode project at: $PROJECT_FILE"
            sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = [^;]*/IPHONEOS_DEPLOYMENT_TARGET = 13.4/g' "$PROJECT_FILE"
            echo "‚úÖ Set IPHONEOS_DEPLOYMENT_TARGET to 13.4"
            # Verify the change
            echo "üîç Verification:"
            grep "IPHONEOS_DEPLOYMENT_TARGET" "$PROJECT_FILE" | head -n 3
          else
            echo "‚ö†Ô∏è Warning: Could not find Xcode project.pbxproj file"
            exit 1
          fi

      - name: üíé Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: üßπ Clean Xcode Derived Data
        run: rm -rf ~/Library/Developer/Xcode/DerivedData

      - name: üì¶ Install xcpretty for clean build output
        run: gem install xcpretty

      - name: üîß Configure Podfile build settings
        working-directory: ios
        run: |
          echo "üîß Adding custom build settings to Podfile post_install hook"

          # Insert custom build settings into the existing post_install hook
          sed -i '' '/post_install do |installer|/a\
          \  # Custom build settings\
          \  installer.pods_project.targets.each do |target|\
          \    target.build_configurations.each do |config|\
          \      config.build_settings["IPHONEOS_DEPLOYMENT_TARGET"] = "13.4"\
          \      config.build_settings["GCC_WARN_INHIBIT_ALL_WARNINGS"] = "YES"\
          \      config.build_settings["SWIFT_SUPPRESS_WARNINGS"] = "YES"\
          \    end\
          \  end\
          ' Podfile

          echo "‚úÖ Podfile configured"

      - name: üì± Install CocoaPods dependencies
        working-directory: ios
        run: |
          echo "Installing pods"
          pod install --verbose

      - name: üîß Fix iOS nullability issues in Pods
        run: |
          chmod +x scripts/fix-ios-nullability.sh
          bash scripts/fix-ios-nullability.sh

      - name: üîß Disable Swift 6 strict concurrency checking
        run: |
          PROJECT_FILE=$(find ios -name "project.pbxproj" -type f | head -n 1)
          if [ -n "$PROJECT_FILE" ]; then
            echo "üì± Disabling strict concurrency checking in: $PROJECT_FILE"
            awk '/buildSettings = \{/ {print; print "\t\t\t\tSWIFT_STRICT_CONCURRENCY = minimal;"; next}1' "$PROJECT_FILE" > "$PROJECT_FILE.tmp"
            mv "$PROJECT_FILE.tmp" "$PROJECT_FILE"
            echo "‚úÖ Swift strict concurrency checking disabled"
          fi

      - name: üîß Set deployment target for all Pods
        run: |
          cd ios
          echo "Setting IPHONEOS_DEPLOYMENT_TARGET for all Pods to 13.4"
          find Pods -name "project.pbxproj" -type f | while read -r file; do
            sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = [^;]*/IPHONEOS_DEPLOYMENT_TARGET = 13.4/g' "$file"
          done
          echo "‚úÖ All Pods deployment targets updated"

      - name: üîç List available schemes
        run: |
          cd ios
          echo "üìã Available schemes in workspace:"
          xcodebuild -list -workspace maya.xcworkspace

      - name: üèóÔ∏è Build iOS (without signing for check)
        env:
          SKIP_SIMULATOR_AVAILABILITY_CHECK: "1"
        run: |
          cd ios
          # Build for iOS device only (avoid simulator runtime issues)
          xcodebuild clean build \
            -workspace maya.xcworkspace \
            -scheme Maya \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -derivedDataPath ./build \
            -skipUnavailableActions \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO \
            SKIP_INSTALL=NO \
            -allowProvisioningUpdates \
            OTHER_LDFLAGS='$(inherited)' | xcpretty || {
            echo "‚ùå Build failed"
            exit 1
          }

          echo "‚úÖ Build succeeded"

      - name: ‚úÖ Build successful
        run: echo "‚úÖ iOS build completed successfully!"

  # ==========================================
  # SUMMARY
  # ==========================================
  build-summary:
    name: üìä Build Summary
    needs: [build-android, build-ios]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: üìä Display build results
        run: |
          echo "======================================"
          echo "üîç BUILD CHECK RESULTS"
          echo "======================================"
          echo ""
          echo "Android Build: ${{ needs.build-android.result }}"
          echo "iOS Build: ${{ needs.build-ios.result }}"
          echo ""
          if [ "${{ needs.build-android.result }}" == "success" ] && [ "${{ needs.build-ios.result }}" == "success" ]; then
            echo "‚úÖ All builds passed!"
          else
            echo "‚ùå Some builds failed. Check logs above."
            exit 1
          fi

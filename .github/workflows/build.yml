name: Build Check with Fastlane

on:
  pull_request:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:

jobs:
  # ==========================================
  # BUILD ANDROID - VÃ©rification du build
  # ==========================================
  build-android:
    name: ğŸ¤– Build Android APK
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ’¾ Backup Fastlane configuration
        run: |
          mkdir -p /tmp/fastlane-backup
          cp -r android/fastlane /tmp/fastlane-backup/ || echo "No fastlane folder to backup"

      - name: ğŸ”¨ Generate Android native folder
        run: npx expo prebuild --platform android --clean

      - name: ğŸ“‹ Restore Fastlane configuration
        run: |
          cp -r /tmp/fastlane-backup/fastlane android/
          echo "Fastlane configuration restored"
          ls -la android/fastlane/

      - name: ğŸ”§ Set gradlew permissions
        working-directory: android
        run: |
          chmod +x gradlew
          echo "âœ… Gradlew permissions set"

      - name: ğŸ”§ Generate React Native Codegen artifacts
        working-directory: android
        run: |
          echo "Generating codegen artifacts for all modules..."
          # Generate codegen artifacts for all native modules, not just the app
          ./gradlew generateCodegenArtifactsFromSchema --stacktrace || {
            echo "âš ï¸ Codegen generation had issues, but continuing..."
            exit 0
          }
          echo "âœ… Codegen artifacts generated"

      - name: ğŸ’ Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: ğŸ” Create dummy keystore for build check
        run: |
          # CrÃ©er un keystore temporaire juste pour vÃ©rifier que le build fonctionne
          keytool -genkey -v -keystore android/app/dummy.keystore \
            -alias dummy -keyalg RSA -keysize 2048 -validity 1 \
            -storepass dummy123 -keypass dummy123 \
            -dname "CN=DummyBuild, OU=Dev, O=Maya, L=City, S=State, C=US"

      - name: âš™ï¸ Create gradle.properties for build check
        run: |
          cat << EOF > android/gradle.properties
          MAYA_UPLOAD_STORE_FILE=dummy.keystore
          MAYA_UPLOAD_KEY_ALIAS=dummy
          MAYA_UPLOAD_STORE_PASSWORD=dummy123
          MAYA_UPLOAD_KEY_PASSWORD=dummy123

          # Gradle settings
          org.gradle.jvmargs=-Xmx2048m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          android.useAndroidX=true
          android.enableJetifier=true

          # React Native / Hermes settings
          hermesEnabled=true
          newArchEnabled=true
          EOF

      - name: ğŸ” Debug - Check paths and fastlane folder
        run: |
          echo "Current directory:"
          pwd
          echo -e "\nRoot directory contents:"
          ls -la
          echo -e "\nAndroid fastlane folder:"
          ls -la android/fastlane/ || echo "android/fastlane not found"

      - name: ğŸ—ï¸ Build Android APK with Fastlane
        working-directory: android
        run: bundle exec fastlane build_apk

      - name: ğŸ“¤ Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-build-check
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 7

      - name: âœ… Build successful
        run: echo "âœ… Android build completed successfully!"

  # ==========================================
  # BUILD iOS - VÃ©rification du build
  # ==========================================
  build-ios:
    name: ğŸ Build iOS (Check Only)
    runs-on: macos-15  # macOS 15 with Xcode 16.x (required by React Native 0.81)

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”§ Select Xcode 16.1
        run: |
          sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer
          xcodebuild -version

      - name: ğŸ”¨ Generate iOS native folder
        run: npx expo prebuild --platform ios --clean

      - name: ğŸ”§ Add post_install hook to Podfile
        run: |
          cd ios
          # Add post_install hook to fix common issues
          cat >> Podfile << 'EOF'

          post_install do |installer|
            installer.pods_project.targets.each do |target|
              target.build_configurations.each do |config|
                # Set minimum deployment target
                config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.4'
                # Disable warnings
                config.build_settings['GCC_WARN_INHIBIT_ALL_WARNINGS'] = 'YES'
                config.build_settings['SWIFT_SUPPRESS_WARNINGS'] = 'YES'
              end
            end
          end
          EOF
          echo "âœ… Post install hook added to Podfile"

      - name: ğŸ”§ Fix iOS nullability issues
        run: |
          chmod +x scripts/fix-ios-nullability.sh
          bash scripts/fix-ios-nullability.sh

      - name: ğŸ”§ Set iOS deployment target in Xcode project
        run: |
          # Find the Xcode project file dynamically
          PROJECT_FILE=$(find ios -name "project.pbxproj" -type f | head -n 1)
          if [ -n "$PROJECT_FILE" ]; then
            echo "ğŸ“± Found Xcode project at: $PROJECT_FILE"
            sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = [^;]*/IPHONEOS_DEPLOYMENT_TARGET = 13.4/g' "$PROJECT_FILE"
            echo "âœ… Set IPHONEOS_DEPLOYMENT_TARGET to 13.4"
            # Verify the change
            echo "ğŸ” Verification:"
            grep "IPHONEOS_DEPLOYMENT_TARGET" "$PROJECT_FILE" | head -n 3
          else
            echo "âš ï¸ Warning: Could not find Xcode project.pbxproj file"
            exit 1
          fi

      - name: ğŸ“¦ Install CocoaPods dependencies
        working-directory: ios
        run: |
          pod install
          echo "âœ… CocoaPods dependencies installed"

      - name: ğŸ”§ Fix iOS nullability issues in Pods
        run: |
          chmod +x scripts/fix-ios-nullability.sh
          bash scripts/fix-ios-nullability.sh

      - name: ğŸ”§ Disable Swift 6 strict concurrency checking
        run: |
          PROJECT_FILE=$(find ios -name "project.pbxproj" -type f | head -n 1)
          if [ -n "$PROJECT_FILE" ]; then
            echo "ğŸ“± Disabling strict concurrency checking in: $PROJECT_FILE"
            # Add SWIFT_STRICT_CONCURRENCY = minimal after each buildSettings opening
            awk '/buildSettings = \{/ {print; print "\t\t\t\tSWIFT_STRICT_CONCURRENCY = minimal;"; next}1' "$PROJECT_FILE" > "$PROJECT_FILE.tmp"
            mv "$PROJECT_FILE.tmp" "$PROJECT_FILE"
            echo "âœ… Swift strict concurrency checking disabled"
          fi

      - name: ğŸ’ Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: ğŸ§¹ Clean Xcode Derived Data
        run: rm -rf ~/Library/Developer/Xcode/DerivedData

      - name: ğŸ“¦ Install xcpretty for clean build output
        run: gem install xcpretty

      - name: ğŸ“± Install CocoaPods dependencies
        run: |
          cd ios
          pod install

      - name: ğŸ”§ Set deployment target for all Pods
        run: |
          cd ios
          echo "Setting IPHONEOS_DEPLOYMENT_TARGET for all Pods to 13.4"
          find Pods -name "project.pbxproj" -type f | while read -r file; do
            sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = [^;]*/IPHONEOS_DEPLOYMENT_TARGET = 13.4/g' "$file"
          done
          echo "âœ… All Pods deployment targets updated"

      - name: ğŸ”§ Fix expo-dev-launcher assets for Release build
        run: |
          DEV_LAUNCHER_ASSETS="ios/Pods/expo-dev-launcher/ios/Assets.xcassets"
          if [ -d "$DEV_LAUNCHER_ASSETS" ]; then
            echo "ğŸ”§ Creating minimal Contents.json for expo-dev-launcher assets"
            # Remove problematic assets and create minimal valid asset catalog
            rm -rf "$DEV_LAUNCHER_ASSETS"
            mkdir -p "$DEV_LAUNCHER_ASSETS"
            cat > "$DEV_LAUNCHER_ASSETS/Contents.json" << 'EOF'
{
  "info" : {
    "version" : 1,
    "author" : "xcode"
  }
}
EOF
            echo "âœ… Minimal asset catalog created"
          else
            echo "âš ï¸ expo-dev-launcher assets directory not found, skipping"
          fi

      - name: ğŸ” List available schemes
        run: |
          cd ios
          echo "ğŸ“‹ Available schemes in workspace:"
          xcodebuild -list -workspace maya.xcworkspace

      - name: ğŸ—ï¸ Build iOS (without signing for check)
        env:
          SKIP_SIMULATOR_AVAILABILITY_CHECK: "1"
        run: |
          cd ios
          # Build for iOS device only (avoid simulator runtime issues)
          xcodebuild clean build \
            -workspace maya.xcworkspace \
            -scheme Maya \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -derivedDataPath ./build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO \
            SKIP_INSTALL=NO \
            -allowProvisioningUpdates \
            OTHER_LDFLAGS='$(inherited)' 2>&1 | tee build.log

          # Check for build failures
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "âŒ Build failed. Last 100 lines of output:"
            tail -100 build.log
            exit 1
          fi

          echo "âœ… Build succeeded"

      - name: âœ… Build successful
        run: echo "âœ… iOS build completed successfully!"

  # ==========================================
  # SUMMARY
  # ==========================================
  build-summary:
    name: ğŸ“Š Build Summary
    needs: [build-android, build-ios]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“Š Display build results
        run: |
          echo "======================================"
          echo "ğŸ” BUILD CHECK RESULTS"
          echo "======================================"
          echo ""
          echo "Android Build: ${{ needs.build-android.result }}"
          echo "iOS Build: ${{ needs.build-ios.result }}"
          echo ""
          if [ "${{ needs.build-android.result }}" == "success" ] && [ "${{ needs.build-ios.result }}" == "success" ]; then
            echo "âœ… All builds passed!"
          else
            echo "âŒ Some builds failed. Check logs above."
            exit 1
          fi

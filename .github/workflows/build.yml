name: Build Check with Fastlane

on:
  pull_request:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:

jobs:
  # ==========================================
  # BUILD ANDROID - VÃ©rification du build
  # ==========================================
  build-android:
    name: ğŸ¤– Build Android APK
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”¨ Generate Android native folder
        run: npx expo prebuild --platform android --clean

      - name: ğŸ’ Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: ğŸ” Create dummy keystore for build check
        run: |
          # CrÃ©er un keystore temporaire juste pour vÃ©rifier que le build fonctionne
          keytool -genkey -v -keystore android/app/dummy.keystore \
            -alias dummy -keyalg RSA -keysize 2048 -validity 1 \
            -storepass dummy123 -keypass dummy123 \
            -dname "CN=DummyBuild, OU=Dev, O=Maya, L=City, S=State, C=US"

      - name: âš™ï¸ Create gradle.properties for build check
        run: |
          cat << EOF > android/gradle.properties
          MAYA_UPLOAD_STORE_FILE=dummy.keystore
          MAYA_UPLOAD_KEY_ALIAS=dummy
          MAYA_UPLOAD_STORE_PASSWORD=dummy123
          MAYA_UPLOAD_KEY_PASSWORD=dummy123

          # Gradle settings
          org.gradle.jvmargs=-Xmx2048m -XX:MaxPermSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          android.useAndroidX=true
          android.enableJetifier=true
          EOF

      - name: ğŸ—ï¸ Build Android APK with Fastlane
        run: |
          cd android
          bundle exec fastlane build_apk

      - name: ğŸ“¤ Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-build-check
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 7

      - name: âœ… Build successful
        run: echo "âœ… Android build completed successfully!"

  # ==========================================
  # BUILD iOS - VÃ©rification du build
  # ==========================================
  build-ios:
    name: ğŸ Build iOS (Check Only)
    runs-on: macos-14

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”¨ Generate iOS native folder
        run: npx expo prebuild --platform ios --clean

      - name: ğŸ’ Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ios

      - name: ğŸ“± Install CocoaPods dependencies
        run: |
          cd ios
          pod install

      - name: ğŸ—ï¸ Build iOS (without signing for check)
        run: |
          cd ios
          xcodebuild clean build \
            -workspace maya.xcworkspace \
            -scheme maya \
            -configuration Release \
            -sdk iphonesimulator \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO

      - name: âœ… Build successful
        run: echo "âœ… iOS build completed successfully!"

  # ==========================================
  # SUMMARY
  # ==========================================
  build-summary:
    name: ğŸ“Š Build Summary
    needs: [build-android, build-ios]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“Š Display build results
        run: |
          echo "======================================"
          echo "ğŸ” BUILD CHECK RESULTS"
          echo "======================================"
          echo ""
          echo "Android Build: ${{ needs.build-android.result }}"
          echo "iOS Build: ${{ needs.build-ios.result }}"
          echo ""
          if [ "${{ needs.build-android.result }}" == "success" ] && [ "${{ needs.build-ios.result }}" == "success" ]; then
            echo "âœ… All builds passed!"
          else
            echo "âŒ Some builds failed. Check logs above."
            exit 1
          fi

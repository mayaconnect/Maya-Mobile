name: Deploy to TestFlight & Google Play

on:
  # DÃ©ploiement automatique sur push vers master
  push:
    branches:
      - master
      - main

  # DÃ©ploiement manuel depuis l'interface GitHub
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to deploy'
        required: true
        type: choice
        options:
          - both
          - android
          - ios
        default: 'both'

jobs:
  # ==========================================
  # JOB ANDROID - Build et Deploy sur Google Play
  # ==========================================
  deploy-android:
    name: ðŸ¤– Android â†’ Google Play
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both'))
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies (excluding dev dependencies for Release)
        run: npm ci --omit=dev

      - name: ðŸ’¾ Backup Fastlane configuration
        run: |
          mkdir -p /tmp/fastlane-backup
          cp -r android/fastlane /tmp/fastlane-backup/ || echo "No fastlane folder to backup"

      - name: ðŸ”¨ Generate Android native folder
        run: npx expo prebuild --platform android --clean

      - name: ðŸ“‹ Restore Fastlane configuration
        run: |
          cp -r /tmp/fastlane-backup/fastlane android/
          echo "Fastlane configuration restored"
          ls -la android/fastlane/

      - name: ðŸ”§ Set gradlew permissions
        working-directory: android
        run: |
          chmod +x gradlew
          echo "âœ… Gradlew permissions set"

      - name: ðŸ”§ Generate React Native Codegen artifacts
        working-directory: android
        run: |
          echo "Generating codegen artifacts for all modules..."
          # Generate codegen artifacts for all native modules, not just the app
          ./gradlew generateCodegenArtifactsFromSchema --stacktrace || {
            echo "âš ï¸ Codegen generation had issues, but continuing..."
            exit 0
          }
          echo "âœ… Codegen artifacts generated"

      - name: ðŸ’Ž Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: ðŸ” Decode Android keystore
        run: |
          echo "ðŸ“¦ Decoding keystore from GitHub secret..."
          mkdir -p android/app
          # Decode base64 keystore and save to android/app/
          # Support both old secret name (ANDROID_KEYSTORE_BASE64) and new (MAYA_UPLOAD_KEYSTORE_BASE64)
          if [ -n "${{ secrets.MAYA_UPLOAD_KEYSTORE_BASE64 }}" ]; then
            echo "${{ secrets.MAYA_UPLOAD_KEYSTORE_BASE64 }}" | base64 --decode > android/app/maya-release.keystore
            KEYSTORE_SECRET="MAYA_UPLOAD_KEYSTORE_BASE64"
          elif [ -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/maya-release.keystore
            KEYSTORE_SECRET="ANDROID_KEYSTORE_BASE64"
          else
            echo "âŒ ERROR: No keystore secret found!"
            echo "Please set either MAYA_UPLOAD_KEYSTORE_BASE64 or ANDROID_KEYSTORE_BASE64 in GitHub Secrets"
            exit 1
          fi
          
          if [ ! -f "android/app/maya-release.keystore" ]; then
            echo "âŒ ERROR: Failed to create keystore file"
            exit 1
          fi
          
          echo "âœ… Keystore decoded successfully at android/app/maya-release.keystore"
          ls -lh android/app/maya-release.keystore
          
          # Verify keystore SHA1 matches expected value
          echo "ðŸ” Verifying keystore SHA1..."
          KEY_ALIAS="${{ secrets.MAYA_UPLOAD_KEY_ALIAS || secrets.ANDROID_KEY_ALIAS }}"
          STORE_PASSWORD="${{ secrets.MAYA_UPLOAD_STORE_PASSWORD || secrets.ANDROID_KEYSTORE_PASSWORD }}"
          EXPECTED_SHA1="${{ secrets.MAYA_UPLOAD_EXPECTED_SHA1 || secrets.ANDROID_KEYSTORE_EXPECTED_SHA1 }}"
          
          if [ -n "$EXPECTED_SHA1" ] && [ -n "$KEY_ALIAS" ] && [ -n "$STORE_PASSWORD" ]; then
            SHA1=$(keytool -list -v -keystore android/app/maya-release.keystore -alias "$KEY_ALIAS" -storepass "$STORE_PASSWORD" 2>/dev/null | grep "SHA1:" | awk '{print $2}' || echo "")
            echo "Keystore SHA1: $SHA1"
            if [ "$SHA1" = "$EXPECTED_SHA1" ]; then
              echo "âœ… Keystore SHA1 matches expected value!"
            else
              echo "âŒ ERROR: Keystore SHA1 does NOT match expected value!"
              echo "Expected: $EXPECTED_SHA1"
              echo "Got:      $SHA1"
              echo ""
              echo "This will cause Google Play to reject the AAB."
              echo "Please update the keystore secret with the correct keystore."
              exit 1
            fi
          else
            echo "â„¹ï¸ Skipping SHA1 verification (no expected SHA1 secret provided or missing alias/password)"
          fi

      - name: âš™ï¸ Configure signing properties (Gradle)
        run: |
          echo "âš™ï¸ Configuring signing properties in gradle.properties..."
          # Ensure gradle.properties exists (expo prebuild may or may not create it)
          if [ ! -f "android/gradle.properties" ]; then
            echo "Creating android/gradle.properties..."
            touch android/gradle.properties
          fi
          
          # Remove any existing MAYA_UPLOAD properties to avoid duplicates
          if [ -f "android/gradle.properties" ]; then
            sed -i.bak '/^MAYA_UPLOAD/d' android/gradle.properties || sed -i '/^MAYA_UPLOAD/d' android/gradle.properties
          fi
          
          # Append signing properties to gradle.properties
          # Support both old and new secret names for backward compatibility
          cat >> android/gradle.properties <<EOF
          # Android signing configuration (injected at CI runtime)
          MAYA_UPLOAD_STORE_FILE=maya-release.keystore
          MAYA_UPLOAD_STORE_PASSWORD=${{ secrets.MAYA_UPLOAD_STORE_PASSWORD || secrets.ANDROID_KEYSTORE_PASSWORD }}
          MAYA_UPLOAD_KEY_ALIAS=${{ secrets.MAYA_UPLOAD_KEY_ALIAS || secrets.ANDROID_KEY_ALIAS }}
          MAYA_UPLOAD_KEY_PASSWORD=${{ secrets.MAYA_UPLOAD_KEY_PASSWORD || secrets.ANDROID_KEY_PASSWORD }}
          EOF
          echo "âœ… Signing properties configured"
          # Show the properties (without passwords) for verification
          echo "Configured properties:"
          grep "MAYA_UPLOAD" android/gradle.properties | sed 's/PASSWORD=.*/PASSWORD=***/' || true
          
          # Also add other Gradle settings if they don't exist
          if ! grep -q "org.gradle.jvmargs" android/gradle.properties; then
            cat >> android/gradle.properties <<EOF
          
          # Gradle settings
          org.gradle.jvmargs=-Xmx2048m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          android.useAndroidX=true
          android.enableJetifier=true
          
          # React Native / Hermes settings
          hermesEnabled=true
          newArchEnabled=true
          EOF
            echo "âœ… Additional Gradle settings added"
          fi

      - name: ðŸ”§ Generate React Native Codegen artifacts
        working-directory: android
        run: |
          echo "Generating codegen artifacts for all modules..."
          # Generate codegen artifacts for all native modules, not just the app
          ./gradlew generateCodegenArtifactsFromSchema --stacktrace || {
            echo "âš ï¸ Codegen generation had issues, but continuing..."
            exit 0
          }
          echo "âœ… Codegen artifacts generated"

      - name: ðŸ”‘ Create Google Play service account JSON
        run: |
          mkdir -p android/fastlane
          echo '${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}' > android/fastlane/google-play-service-account.json
          echo "Service account configured"

      - name: â˜• Verify Java and jarsigner availability
        run: |
          echo "â˜• Checking Java installation..."
          java -version
          echo ""
          echo "ðŸ” Checking jarsigner availability..."
          jarsigner -help > /dev/null 2>&1 && echo "âœ… jarsigner is available" || (echo "âŒ jarsigner not found" && exit 1)
          keytool -help > /dev/null 2>&1 && echo "âœ… keytool is available" || (echo "âŒ keytool not found" && exit 1)

      - name: ðŸ”¨ Build Android App Bundle (AAB) - Unsigned
        working-directory: android
        run: |
          echo "ðŸ”¨ Building UNSIGNED AAB with Gradle (will be signed with jarsigner after)..."
          # Build without signing - we'll sign with jarsigner afterwards
          ./gradlew bundleRelease -PBUILD_UNSIGNED_AAB=true --stacktrace --info --no-daemon
          echo "âœ… Unsigned AAB built successfully"
          ls -lh app/build/outputs/bundle/release/app-release.aab

      - name: âœï¸ Sign AAB with jarsigner
        working-directory: android
        run: |
          echo "âœï¸ Signing AAB with jarsigner..."
          AAB_PATH="app/build/outputs/bundle/release/app-release.aab"
          KEYSTORE_PATH="app/maya-release.keystore"
          KEY_ALIAS="${{ secrets.MAYA_UPLOAD_KEY_ALIAS || secrets.ANDROID_KEY_ALIAS }}"
          STORE_PASSWORD="${{ secrets.MAYA_UPLOAD_STORE_PASSWORD || secrets.ANDROID_KEYSTORE_PASSWORD }}"
          KEY_PASSWORD="${{ secrets.MAYA_UPLOAD_KEY_PASSWORD || secrets.ANDROID_KEY_PASSWORD }}"
          
          if [ ! -f "$AAB_PATH" ]; then
            echo "âŒ ERROR: AAB file not found at $AAB_PATH"
            exit 1
          fi
          
          if [ ! -f "$KEYSTORE_PATH" ]; then
            echo "âŒ ERROR: Keystore file not found at $KEYSTORE_PATH"
            exit 1
          fi
          
          echo "ðŸ“¦ Signing $AAB_PATH with keystore $KEYSTORE_PATH (alias: $KEY_ALIAS)..."
          echo "   (AAB was built unsigned with BUILD_UNSIGNED_AAB=true, so this will be the only signature)"
          jarsigner \
            -keystore "$KEYSTORE_PATH" \
            -storepass "$STORE_PASSWORD" \
            -keypass "$KEY_PASSWORD" \
            -sigalg SHA256withRSA \
            -digestalg SHA-256 \
            "$AAB_PATH" \
            "$KEY_ALIAS"
          
          echo "âœ… AAB signed successfully"

      - name: ðŸ” Verify AAB signature (single certificate chain)
        working-directory: android
        run: |
          echo "ðŸ” Verifying AAB signature and checking for single certificate chain..."
          AAB_PATH="app/build/outputs/bundle/release/app-release.aab"
          
          # Verify signature
          echo "Running jarsigner verification..."
          jarsigner -verify -verbose -certs "$AAB_PATH" > /tmp/jarsigner_output.txt 2>&1
          VERIFY_EXIT_CODE=$?
          
          if [ $VERIFY_EXIT_CODE -ne 0 ]; then
            echo "âŒ ERROR: AAB signature verification failed"
            cat /tmp/jarsigner_output.txt
            exit 1
          fi
          
          # Check for multiple certificate chains
          echo ""
          echo "Checking certificate chains..."
          CERT_COUNT=$(grep -c "Certificate chain" /tmp/jarsigner_output.txt || echo "0")
          
          if [ "$CERT_COUNT" -gt 1 ]; then
            echo "âŒ ERROR: Multiple certificate chains detected ($CERT_COUNT chains)"
            echo "This will cause Google Play to reject the AAB."
            echo ""
            echo "Full verification output:"
            cat /tmp/jarsigner_output.txt
            exit 1
          elif [ "$CERT_COUNT" -eq 1 ]; then
            echo "âœ… Single certificate chain confirmed"
          else
            echo "âš ï¸ WARNING: Could not determine certificate chain count"
          fi
          
          echo ""
          echo "âœ… AAB signature verified successfully with single certificate chain"
          echo "Certificate details:"
          grep -A 5 "Certificate chain" /tmp/jarsigner_output.txt | head -20 || cat /tmp/jarsigner_output.txt

      - name: ðŸš€ Upload to Google Play Internal Testing
        working-directory: android
        run: bundle exec fastlane upload_internal
        env:
          SUPPLY_JSON_KEY: ./fastlane/google-play-service-account.json

      - name: ðŸ“¤ Upload Android artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: android-release-aab
          path: android/app/build/outputs/bundle/release/app-release.aab
          retention-days: 30

      - name: âœ… Android deployment success
        if: success()
        run: |
          echo "âœ… Android app successfully deployed to Google Play Internal Testing!"
          echo "ðŸ“± Go to Google Play Console to test: https://play.google.com/console/"

  # ==========================================
  # JOB iOS - Build et Deploy sur TestFlight
  # ==========================================
  deploy-ios:
    name: ðŸŽ iOS â†’ TestFlight
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both'))
    runs-on: macos-15  # macOS 15 has Xcode 16.x

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies (excluding dev dependencies for Release)
        run: npm ci --omit=dev

      - name: ðŸ”§ Select Xcode 16.1
        run: |
          sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer
          xcodebuild -version

      - name: ðŸ”¨ Generate iOS native folder
        run: npx expo prebuild --platform ios --clean

      - name: ðŸ”§ Fix iOS nullability issues
        run: |
          chmod +x scripts/fix-ios-nullability.sh
          bash scripts/fix-ios-nullability.sh

      - name: ðŸ”§ Set iOS deployment target in Xcode project
        run: |
          # Find the Xcode project file dynamically
          PROJECT_FILE=$(find ios -name "project.pbxproj" -type f | head -n 1)
          if [ -n "$PROJECT_FILE" ]; then
            echo "ðŸ“± Found Xcode project at: $PROJECT_FILE"
            sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = [^;]*/IPHONEOS_DEPLOYMENT_TARGET = 13.4/g' "$PROJECT_FILE"
            echo "âœ… Set IPHONEOS_DEPLOYMENT_TARGET to 13.4"
            # Verify the change
            echo "ðŸ” Verification:"
            grep "IPHONEOS_DEPLOYMENT_TARGET" "$PROJECT_FILE" | head -n 3
          else
            echo "âš ï¸ Warning: Could not find Xcode project.pbxproj file"
            exit 1
          fi

      - name: ðŸ’Ž Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: ðŸ§¹ Clean Xcode Derived Data
        run: rm -rf ~/Library/Developer/Xcode/DerivedData

      - name: ðŸ”§ Configure Podfile build settings
        working-directory: ios
        run: |
          echo "ðŸ”§ Adding custom build settings to Podfile post_install hook"

          # Insert custom build settings into the existing post_install hook
          sed -i '' '/post_install do |installer|/a\
          \  # Custom build settings\
          \  installer.pods_project.targets.each do |target|\
          \    target.build_configurations.each do |config|\
          \      config.build_settings["IPHONEOS_DEPLOYMENT_TARGET"] = "13.4"\
          \      config.build_settings["GCC_WARN_INHIBIT_ALL_WARNINGS"] = "YES"\
          \      config.build_settings["SWIFT_SUPPRESS_WARNINGS"] = "YES"\
          \    end\
          \  end\
          ' Podfile

          echo "âœ… Podfile configured"

      - name: ðŸ“¦ Install CocoaPods dependencies
        working-directory: ios
        run: |
          pod install
          echo "âœ… CocoaPods dependencies installed"

      - name: ðŸ”§ Set deployment target for all Pods
        run: |
          cd ios
          echo "Setting IPHONEOS_DEPLOYMENT_TARGET for all Pods to 13.4"
          find Pods -name "project.pbxproj" -type f | while read -r file; do
            sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = [^;]*/IPHONEOS_DEPLOYMENT_TARGET = 13.4/g' "$file"
          done
          echo "âœ… All Pods deployment targets updated"

      - name: ðŸ”§ Disable Swift 6 strict concurrency checking
        run: |
          PROJECT_FILE=$(find ios -name "project.pbxproj" -type f | head -n 1)
          if [ -n "$PROJECT_FILE" ]; then
            echo "ðŸ“± Disabling strict concurrency checking in: $PROJECT_FILE"
            awk '/buildSettings = \{/ {print; print "\t\t\t\tSWIFT_STRICT_CONCURRENCY = minimal;"; next}1' "$PROJECT_FILE" > "$PROJECT_FILE.tmp"
            mv "$PROJECT_FILE.tmp" "$PROJECT_FILE"
            echo "âœ… Swift strict concurrency checking disabled"
          fi

      - name: ðŸ” Setup App Store Connect API Key
        run: |
          mkdir -p ios/fastlane/keys
          echo "${{ secrets.APP_STORE_CONNECT_KEY_BASE64 }}" | base64 -d > ios/fastlane/keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8
          chmod 600 ios/fastlane/keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8
          echo "App Store Connect API Key configured"

      - name: ðŸ“œ Setup Match certificates
        working-directory: ios
        run: bundle exec fastlane match appstore --readonly
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}

      - name: ðŸš€ Build and Deploy to TestFlight
        working-directory: ios
        run: bundle exec fastlane beta
        env:
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}

      - name: ðŸ“¤ Upload iOS artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ios-release-ipa
          path: ios/*.ipa
          retention-days: 30

      - name: âœ… iOS deployment success
        if: success()
        run: |
          echo "âœ… iOS app successfully deployed to TestFlight!"
          echo "ðŸ“± Go to App Store Connect to test: https://appstoreconnect.apple.com/"

  # ==========================================
  # JOB NOTIFICATION - RÃ©sumÃ© final
  # ==========================================
  notify-success:
    name: ðŸ“¢ Deployment Summary
    needs: [deploy-android, deploy-ios]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“Š Deployment Summary
        run: |
          echo "======================================"
          echo "ðŸŽ‰ DEPLOYMENT COMPLETED"
          echo "======================================"
          echo ""
          echo "Android Status: ${{ needs.deploy-android.result }}"
          echo "iOS Status: ${{ needs.deploy-ios.result }}"
          echo ""
          if [ "${{ needs.deploy-android.result }}" == "success" ]; then
            echo "âœ… Android: https://play.google.com/console/"
          fi
          if [ "${{ needs.deploy-ios.result }}" == "success" ]; then
            echo "âœ… iOS: https://appstoreconnect.apple.com/"
          fi
          echo ""
          echo "======================================"
name: Deploy to TestFlight & Google Play

on:
  # D√©ploiement automatique sur push vers master
  push:
    branches:
      - master
      - main

  # D√©ploiement manuel depuis l'interface GitHub
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to deploy'
        required: true
        type: choice
        options:
          - both
          - android
          - ios
        default: 'both'

jobs:
  # ==========================================
  # JOB ANDROID - Build et Deploy sur Google Play
  # ==========================================
  deploy-android:
    name: ü§ñ Android ‚Üí Google Play
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both'))
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üóëÔ∏è Remove expo-dev-client (not needed for production builds)
        run: npm uninstall expo-dev-client

      - name: üíæ Backup Fastlane configuration
        run: |
          mkdir -p /tmp/fastlane-backup
          cp -r android/fastlane /tmp/fastlane-backup/ || echo "No fastlane folder to backup"

      - name: üî® Generate Android native folder
        run: npx expo prebuild --platform android --clean

      - name: üìã Restore Fastlane configuration
        run: |
          cp -r /tmp/fastlane-backup/fastlane android/
          echo "Fastlane configuration restored"

      - name: üíé Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: üîê Setup Android keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/maya-release.keystore
          echo "Keystore created successfully"

      - name: ‚öôÔ∏è Create gradle.properties
        run: |
          cat << EOF > android/gradle.properties
          MAYA_UPLOAD_STORE_FILE=maya-release.keystore
          MAYA_UPLOAD_KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}
          MAYA_UPLOAD_STORE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          MAYA_UPLOAD_KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}

          # Gradle settings
          org.gradle.jvmargs=-Xmx2048m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          android.useAndroidX=true
          android.enableJetifier=true

          # React Native / Hermes settings
          hermesEnabled=true
          newArchEnabled=true
          EOF
          echo "Gradle properties configured"

      - name: üîë Create Google Play service account JSON
        run: |
          mkdir -p android/fastlane
          echo '${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}' > android/fastlane/google-play-service-account.json
          echo "Service account configured"

      - name: üöÄ Deploy to Google Play Internal Testing
        working-directory: android
        run: bundle exec fastlane internal
        env:
          SUPPLY_JSON_KEY: ./fastlane/google-play-service-account.json

      - name: üì§ Upload Android artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: android-release-aab
          path: android/app/build/outputs/bundle/release/app-release.aab
          retention-days: 30

      - name: ‚úÖ Android deployment success
        if: success()
        run: |
          echo "‚úÖ Android app successfully deployed to Google Play Internal Testing!"
          echo "üì± Go to Google Play Console to test: https://play.google.com/console/"

  # ==========================================
  # JOB iOS - Build et Deploy sur TestFlight
  # ==========================================
  deploy-ios:
    name: üçé iOS ‚Üí TestFlight
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both'))
    runs-on: macos-15  # macOS 15 has Xcode 16.x

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üóëÔ∏è Remove expo-dev-client (not needed for production builds)
        run: npm uninstall expo-dev-client

      - name: üîß Select Xcode 16.1
        run: sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer

      - name: üî® Generate iOS native folder
        run: npx expo prebuild --platform ios --clean

      - name: üîß Fix iOS nullability issues
        run: |
          chmod +x scripts/fix-ios-nullability.sh
          bash scripts/fix-ios-nullability.sh

      - name: üîß Set iOS deployment target in Xcode project
        run: |
          # Find the Xcode project file dynamically
          PROJECT_FILE=$(find ios -name "project.pbxproj" -type f | head -n 1)
          if [ -n "$PROJECT_FILE" ]; then
            echo "üì± Found Xcode project at: $PROJECT_FILE"
            sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = [^;]*/IPHONEOS_DEPLOYMENT_TARGET = 17.0/g' "$PROJECT_FILE"
            echo "‚úÖ Set IPHONEOS_DEPLOYMENT_TARGET to 17.0"
            # Verify the change
            echo "üîç Verification:"
            grep "IPHONEOS_DEPLOYMENT_TARGET" "$PROJECT_FILE" | head -n 3
          else
            echo "‚ö†Ô∏è Warning: Could not find Xcode project.pbxproj file"
            exit 1
          fi

      - name: üì¶ Install CocoaPods dependencies
        working-directory: ios
        run: |
          pod install
          echo "‚úÖ CocoaPods dependencies installed"

      - name: üîß Fix iOS nullability issues in Pods
        run: |
          chmod +x scripts/fix-ios-nullability.sh
          bash scripts/fix-ios-nullability.sh

      - name: üîß Disable Swift 6 strict concurrency checking
        run: |
          PROJECT_FILE=$(find ios -name "project.pbxproj" -type f | head -n 1)
          if [ -n "$PROJECT_FILE" ]; then
            echo "üì± Disabling strict concurrency checking in: $PROJECT_FILE"
            # Add SWIFT_STRICT_CONCURRENCY = minimal after each buildSettings opening
            awk '/buildSettings = \{/ {print; print "\t\t\t\tSWIFT_STRICT_CONCURRENCY = minimal;"; next}1' "$PROJECT_FILE" > "$PROJECT_FILE.tmp"
            mv "$PROJECT_FILE.tmp" "$PROJECT_FILE"
            echo "‚úÖ Swift strict concurrency checking disabled"
          fi

      - name: üíé Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: üîê Setup App Store Connect API Key
        run: |
          mkdir -p ios/fastlane/keys
          echo "${{ secrets.APP_STORE_CONNECT_KEY_BASE64 }}" | base64 -d > ios/fastlane/keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8
          chmod 600 ios/fastlane/keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8
          echo "App Store Connect API Key configured"

      - name: üìú Setup Match certificates
        working-directory: ios
        run: bundle exec fastlane match appstore --readonly
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}

      - name: üöÄ Build and Deploy to TestFlight
        working-directory: ios
        run: bundle exec fastlane beta
        env:
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}

      - name: üì§ Upload iOS artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ios-release-ipa
          path: ios/*.ipa
          retention-days: 30

      - name: ‚úÖ iOS deployment success
        if: success()
        run: |
          echo "‚úÖ iOS app successfully deployed to TestFlight!"
          echo "üì± Go to App Store Connect to test: https://appstoreconnect.apple.com/"

  # ==========================================
  # JOB NOTIFICATION - R√©sum√© final
  # ==========================================
  notify-success:
    name: üì¢ Deployment Summary
    needs: [deploy-android, deploy-ios]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: üìä Deployment Summary
        run: |
          echo "======================================"
          echo "üéâ DEPLOYMENT COMPLETED"
          echo "======================================"
          echo ""
          echo "Android Status: ${{ needs.deploy-android.result }}"
          echo "iOS Status: ${{ needs.deploy-ios.result }}"
          echo ""
          if [ "${{ needs.deploy-android.result }}" == "success" ]; then
            echo "‚úÖ Android: https://play.google.com/console/"
          fi
          if [ "${{ needs.deploy-ios.result }}" == "success" ]; then
            echo "‚úÖ iOS: https://appstoreconnect.apple.com/"
          fi
          echo ""
          echo "======================================"

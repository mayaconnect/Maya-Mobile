name: Deploy to TestFlight & Google Play

on:
  # DÃ©ploiement automatique sur push vers master
  push:
    branches:
      - master
      - main

  # DÃ©ploiement manuel depuis l'interface GitHub
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to deploy'
        required: true
        type: choice
        options:
          - both
          - android
          - ios
        default: 'both'

jobs:
  # ==========================================
  # JOB ANDROID - Build et Deploy sur Google Play
  # ==========================================
  deploy-android:
    name: ğŸ¤– Android â†’ Google Play (EAS Build)
    # Annule les anciens jobs en queue quand un nouveau est dÃ©clenchÃ©
    concurrency:
      group: deploy-android
      cancel-in-progress: true
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both'))
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: ğŸ”§ Install EAS CLI
        run: npm install -g eas-cli

      - name: ğŸ—ï¸ Build Android with EAS
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          echo "ğŸ” EAS credentials configured via EXPO_TOKEN"
          echo "ğŸ—ï¸ Building Android app with EAS Build..."
          echo "   Profile: production"
          echo "   Platform: android"
          echo ""
          eas build --platform android --profile production --non-interactive --wait
          echo "âœ… Build completed successfully"

      - name: ğŸ”‘ Setup Google Service Account
        run: |
          echo "ğŸ”‘ Creating Google Service Account file..."
          echo "${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}" > google-service-account.json
          chmod 600 google-service-account.json
          echo "âœ… Google Service Account file created"

      - name: ğŸ“¤ Submit to Google Play
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          echo "ğŸ“¤ Submitting latest build to Google Play..."
          eas submit --platform android --profile production --latest --non-interactive
          echo "âœ… Submission to Google Play completed"

      - name: âœ… Android deployment success
        if: success()
        run: |
          echo "âœ… Android app successfully built and deployed to Google Play!"
          echo "ğŸ“± Go to Google Play Console to test: https://play.google.com/console/"
          echo "ğŸ“Š View builds: https://expo.dev/accounts/[your-account]/projects/maya-mobile-app/builds"

  # ==========================================
  # JOB iOS - Build et Deploy sur TestFlight
  # ==========================================
  deploy-ios:
    name: ğŸ iOS â†’ TestFlight (EAS Build)
    # Annule les anciens jobs en queue quand un nouveau est dÃ©clenchÃ©
    concurrency:
      group: deploy-ios
      cancel-in-progress: true
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both'))
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: ğŸ”§ Install EAS CLI
        run: npm install -g eas-cli

      - name: ğŸ”‘ Setup App Store Connect API Key
        run: |
          echo "ğŸ”‘ Creating App Store Connect API Key file..."
          mkdir -p fastlane/keys
          echo "${{ secrets.APP_STORE_CONNECT_KEY_BASE64 }}" | base64 -d > fastlane/keys/AuthKey_44Z65DA5ZQ.p8
          chmod 600 fastlane/keys/AuthKey_44Z65DA5ZQ.p8
          echo "âœ… API Key file created"

      - name: ğŸ—ï¸ Build iOS with EAS
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          echo "ğŸ” EAS credentials configured via EXPO_TOKEN"
          echo "ğŸ—ï¸ Building iOS app with EAS Build..."
          echo "   Profile: production"
          echo "   Platform: ios"
          echo ""
          eas build --platform ios --profile production --non-interactive --wait
          echo "âœ… Build completed successfully"

      - name: ğŸ“¤ Submit to TestFlight
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          echo "ğŸ“¤ Submitting latest build to TestFlight..."
          eas submit --platform ios --profile production --latest --non-interactive
          echo "âœ… Submission to TestFlight completed"

      - name: âœ… iOS deployment success
        if: success()
        run: |
          echo "âœ… iOS app successfully built and deployed to TestFlight!"
          echo "ğŸ“± Go to App Store Connect to test: https://appstoreconnect.apple.com/"
          echo "ğŸ“Š View builds: https://expo.dev/accounts/[your-account]/projects/maya-mobile-app/builds"

  # ==========================================
  # JOB NOTIFICATION - RÃ©sumÃ© final
  # ==========================================
  notify-success:
    name: ğŸ“¢ Deployment Summary
    needs: [deploy-ios, deploy-android]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“Š Deployment Summary
        run: |
          echo "======================================"
          echo "ğŸ‰ DEPLOYMENT COMPLETED"
          echo "======================================"
          echo ""
          if [ "${{ needs.deploy-ios.result }}" == "success" ]; then
            echo "âœ… iOS: https://appstoreconnect.apple.com/"
          fi
          if [ "${{ needs.deploy-android.result }}" == "success" ]; then
            echo "âœ… Android: https://play.google.com/console/"
          fi
          echo ""
          echo "======================================"
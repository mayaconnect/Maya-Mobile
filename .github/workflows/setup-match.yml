name: Setup Match (One-Time iOS Certificates) - API Key Only

# ---------------------------------------------------------------------------
#  ‚ö†Ô∏è  Ce workflow s'ex√©cute UNE SEULE FOIS pour initialiser fastlane match
#      - Utilise UNIQUEMENT une App Store Connect API Key (pas d'Apple ID / 2FA)
#      - Cr√©e les certificats iOS + provisioning profiles
#      - Stocke tout dans votre repo Git (MATCH_GIT_URL)
# ---------------------------------------------------------------------------

on:
  workflow_dispatch:

jobs:
  setup-match:
    name: üîê Initialize Match & Create iOS Certificates (API Key)
    runs-on: macos-15 # macOS 15 has Xcode 16.x

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # ------------------------------
      #  Node & d√©pendances JS
      # ------------------------------
      - name: üì¶ Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          npm ci

      - name: üóëÔ∏è Remove expo-dev-client (not needed for production builds)
        shell: bash
        run: |
          set -euo pipefail
          npm uninstall expo-dev-client

      # ------------------------------
      #  iOS native project (Expo)
      # ------------------------------
      - name: üîß Select Xcode 16.1
        shell: bash
        run: |
          set -euo pipefail
          sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer

      - name: üî® Generate iOS native folder
        shell: bash
        run: |
          set -euo pipefail
          npx expo prebuild --platform ios --clean

      - name: üîß Fix iOS nullability issues
        shell: bash
        run: |
          set -euo pipefail
          chmod +x scripts/fix-ios-nullability.sh
          bash scripts/fix-ios-nullability.sh

      # ------------------------------
      #  Ruby & fastlane
      # ------------------------------
      - name: üíé Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true

      # ------------------------------
      #  App Store Connect API Key
      #  - D√©code la cl√© .p8 depuis le secret BASE64
      #  - G√©n√®re ios/fastlane/keys/api_key.json au format attendu par fastlane
      # ------------------------------
      - name: üîê Create App Store Connect API Key files (p8 + api_key.json)
        shell: bash
        env:
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_KEY_BASE64 }}
        run: |
          set -euo pipefail

          mkdir -p ios/fastlane/keys

          # 1) √âcrire le fichier .p8 √† partir du secret base64
          p8_path="ios/fastlane/keys/AuthKey_${APP_STORE_CONNECT_KEY_ID}.p8"
          echo "${APP_STORE_CONNECT_KEY_BASE64}" | base64 -d > "${p8_path}"
          chmod 600 "${p8_path}"

          # 2) Cr√©er api_key.json pour fastlane (key_id, issuer_id, key)
          # Utiliser Python pour cr√©er le JSON correctement √©chapp√©
          python3 <<PY
          import json
          import os
          from pathlib import Path

          key_id = os.environ['APP_STORE_CONNECT_KEY_ID']
          issuer_id = os.environ['APP_STORE_CONNECT_ISSUER_ID']
          p8_path = Path(f'ios/fastlane/keys/AuthKey_{key_id}.p8')
          
          # Lire la cl√© priv√©e
          key_content = p8_path.read_text(encoding='utf-8')
          
          # Cr√©er le dictionnaire JSON
          api_key_data = {
              "key_id": key_id,
              "issuer_id": issuer_id,
              "key": key_content
          }
          
          # √âcrire le fichier JSON avec √©chappement correct
          api_key_path = Path('ios/fastlane/keys/api_key.json')
          with open(api_key_path, 'w', encoding='utf-8') as f:
              json.dump(api_key_data, f, indent=2, ensure_ascii=False)
          PY

          echo "‚úÖ API Key files created"
          
          # V√©rifier que les fichiers sont cr√©√©s correctement
          if [ ! -f "${p8_path}" ]; then
            echo "‚ùå ERROR: .p8 file not created at ${p8_path}"
            exit 1
          fi
          
          if [ ! -f "ios/fastlane/keys/api_key.json" ]; then
            echo "‚ùå ERROR: api_key.json not created"
            exit 1
          fi
          
          # V√©rifier le format JSON
          if ! python3 -m json.tool ios/fastlane/keys/api_key.json > /dev/null 2>&1; then
            echo "‚ùå ERROR: api_key.json is not valid JSON"
            echo "Content (first 500 chars):"
            head -c 500 ios/fastlane/keys/api_key.json
            exit 1
          fi
          
          echo "‚úÖ Files validated successfully"

      # ------------------------------
      # Validation des credentials App Store Connect
      # ------------------------------
      - name: üîç Validate App Store Connect API Key
        working-directory: ios
        shell: bash
        run: |
          set -euo pipefail
          
          echo "üîç Validating App Store Connect API Key..."
          
          # V√©rifier que le fichier api_key.json existe
          if [ ! -f "fastlane/keys/api_key.json" ]; then
            echo "‚ùå ERROR: api_key.json not found"
            exit 1
          fi
          
          # Afficher les informations (sans la cl√© compl√®te pour la s√©curit√©)
          echo "üìã API Key Info:"
          python3 <<PY
          import json
          from pathlib import Path
          
          api_key_path = Path('fastlane/keys/api_key.json')
          with open(api_key_path, 'r') as f:
              data = json.load(f)
          
          print(f"  Key ID: {data.get('key_id', 'MISSING')}")
          print(f"  Issuer ID: {data.get('issuer_id', 'MISSING')}")
          key_preview = data.get('key', '')[:50] if data.get('key') else 'MISSING'
          print(f"  Key preview: {key_preview}...")
          PY
          
          # Tester l'authentification avec une commande simple
          echo "üîê Testing authentication with App Store Connect..."
          if bundle exec fastlane spaceship --help > /dev/null 2>&1; then
            echo "‚úÖ Fastlane is ready"
          else
            echo "‚ö†Ô∏è  Warning: Could not verify fastlane, but continuing..."
          fi

      # ------------------------------
      # Matchfile (configuration de fastlane match)
      # ------------------------------
      - name: üìù Create Matchfile (API Key only)
        shell: bash
        run: |
          set -euo pipefail

          cat > ios/fastlane/Matchfile <<EOF
          git_url("${{ secrets.MATCH_GIT_URL }}")
          storage_mode("git")
          type("appstore")
          app_identifier(["com.mayaconnect.app"])
          api_key_path("fastlane/keys/api_key.json")

      # ------------------------------
      # Diagnostic de l'authentification Git
      # ------------------------------
      - name: üîç Test Git Authentication
        shell: bash
        env:
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
        run: |
          set -euo pipefail

          echo "üîç Testing Git authentication..."
          echo "Repository URL: ${MATCH_GIT_URL}"
          
          # V√©rifier que les secrets sont d√©finis
          if [ -z "${MATCH_GIT_URL}" ]; then
            echo "‚ùå ERROR: MATCH_GIT_URL is not set"
            exit 1
          fi
          
          if [ -z "${MATCH_GIT_BASIC_AUTHORIZATION}" ]; then
            echo "‚ùå ERROR: MATCH_GIT_BASIC_AUTHORIZATION is not set"
            exit 1
          fi
          
          # D√©coder et v√©rifier le format de l'authentification
          echo "üîê Decoding authentication (first 20 chars only for security)..."
          DECODED=$(echo "${MATCH_GIT_BASIC_AUTHORIZATION}" | base64 -d 2>/dev/null || echo "INVALID_BASE64")
          if [ "${DECODED}" = "INVALID_BASE64" ]; then
            echo "‚ùå ERROR: MATCH_GIT_BASIC_AUTHORIZATION is not valid base64"
            exit 1
          fi
          
          # V√©rifier le format username:token
          if [[ ! "${DECODED}" =~ ^[^:]+:.+$ ]]; then
            echo "‚ùå ERROR: Authentication format should be 'username:token', got: ${DECODED:0:20}..."
            exit 1
          fi
          
          USERNAME=$(echo "${DECODED}" | cut -d: -f1)
          echo "‚úÖ Username detected: ${USERNAME}"
          echo "‚úÖ Authentication format is correct"
          
          # Tester l'acc√®s au repository
          echo "üîç Testing repository access..."
          TEMP_DIR=$(mktemp -d)
          trap "rm -rf ${TEMP_DIR}" EXIT
          
          if git clone \
            -c http.extraheader="Authorization: Basic ${MATCH_GIT_BASIC_AUTHORIZATION}" \
            "${MATCH_GIT_URL}" \
            "${TEMP_DIR}/test-clone" \
            2>&1; then
            echo "‚úÖ Repository access successful!"
            rm -rf "${TEMP_DIR}"
          else
            echo "‚ùå ERROR: Cannot access repository"
            echo "Please check:"
            echo "  1. Repository exists and is private"
            echo "  2. PAT token has 'repo' scope"
            echo "  3. PAT token has access to this repository"
            echo "  4. Username in base64 matches your GitHub username"
            exit 1
          fi

      # ------------------------------
      # Initialisation de match
      # ------------------------------
      - name: üé´ Initialize Match and Create Certificates (API Key)
        working-directory: ios
        shell: bash
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
        run: |
          set -euo pipefail

          echo "üîê Initializing Match with App Store Connect API Key..."
          bundle exec fastlane match appstore --verbose --force --skip_certificate_matching

          echo "‚úÖ Match initialized successfully!"
          echo "‚úÖ Certificates and profiles stored in: ${{ secrets.MATCH_GIT_URL }}"

      # ------------------------------
      # R√©sum√©
      # ------------------------------
      - name: ‚úÖ Success - Match is ready!
        shell: bash
        run: |
          set -euo pipefail

          echo "======================================"
          echo "üéâ MATCH SETUP COMPLETED!"
          echo "======================================"
          echo ""
          echo "‚úÖ iOS Certificates created"
          echo "‚úÖ Provisioning Profiles created"
          echo "‚úÖ Everything stored in: ${{ secrets.MATCH_GIT_URL }}"
          echo ""
          echo "üìã Next steps:"
          echo "1. The deploy workflow can now build iOS"
          echo "2. You can disable or delete this workflow"
          echo ""

